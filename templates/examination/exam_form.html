{% extends 'base.html' %}
{% load widget_tweaks %}

{% block title %}Create Exam - SMS{% endblock %}

{% block content %}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Create New Exam</h1>
    <a href="{% url 'exam_list' %}" class="d-none d-sm-inline-block btn btn-sm btn-secondary shadow-sm">
        <i class="fas fa-arrow-left fa-sm text-white-50"></i> Back to List
    </a>
</div>

<div class="card shadow mb-4">
    <div class="card-body">
        <form method="post">
            {% csrf_token %}
            
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.name.id_for_label }}" class="form-label">Exam Name</label>
                    {% render_field form.name class="form-control" %}
                    <div class="invalid-feedback">{{ form.name.errors }}</div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.academic_year.id_for_label }}" class="form-label">Academic Year</label>
                    {% render_field form.academic_year class="form-select" %}
                    <div class="invalid-feedback">{{ form.academic_year.errors }}</div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.exam_class.id_for_label }}" class="form-label">Class</label>
                    {% render_field form.exam_class class="form-select" %}
                    <div class="invalid-feedback">{{ form.exam_class.errors }}</div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.section.id_for_label }}" class="form-label">Section</label>
                    {% render_field form.section class="form-select" %}
                    <div class="invalid-feedback">{{ form.section.errors }}</div>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="{{ form.start_date.id_for_label }}" class="form-label">Start Date</label>
                    {% render_field form.start_date class="form-control" type="date" %}
                    <div class="invalid-feedback">{{ form.start_date.errors }}</div>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="{{ form.end_date.id_for_label }}" class="form-label">End Date</label>
                    {% render_field form.end_date class="form-control" type="date" %}
                    <div class="invalid-feedback">{{ form.end_date.errors }}</div>
                </div>
            </div>

            <div class="mb-3">
                <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                {% render_field form.description class="form-control" rows="3" %}
                <div class="invalid-feedback">{{ form.description.errors }}</div>
            </div>

            <div class="mb-3 form-check">
                {% render_field form.is_active class="form-check-input" %}
                <label class="form-check-label" for="{{ form.is_active.id_for_label }}">Active</label>
            </div>

            <hr>
            <h5 class="mb-3">Exam Schedule (Routine)</h5>
            {{ schedules.management_form }}
            <div id="schedule-form-list">
                {% for schedule_form in schedules %}
                <div class="card mb-3 schedule-form">
                    <div class="card-body">
                        {{ schedule_form.id }}
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <label class="form-label">Subject</label>
                                {% render_field schedule_form.subject class="form-select" %}
                            </div>
                            <div class="col-md-4 mb-2">
                                <label class="form-label">Date</label>
                                {% render_field schedule_form.date class="form-control" type="date" %}
                            </div>
                            <div class="col-md-4 mb-2">
                                <label class="form-label">Max Marks</label>
                                {% render_field schedule_form.max_marks class="form-control" %}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-2">
                                <label class="form-label">Start Time</label>
                                {% render_field schedule_form.start_time class="form-control" type="time" %}
                            </div>
                            <div class="col-md-4 mb-2">
                                <label class="form-label">End Time</label>
                                {% render_field schedule_form.end_time class="form-control" type="time" %}
                            </div>
                            <div class="col-md-4 mb-2 d-flex align-items-end">
                                {% if schedules.can_delete %}
                                <div class="form-check">
                                    {{ schedule_form.DELETE }}
                                    <label class="form-check-label" for="{{ schedule_form.DELETE.id_for_label }}">Delete</label>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <button type="button" id="add-schedule" class="btn btn-secondary mb-3">Add Schedule</button>
            <br>
            <button type="submit" class="btn btn-primary">Save Exam</button>
        </form>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const classSelect = document.getElementById('id_exam_class');
        const sectionSelect = document.getElementById('id_section');
        const addBtn = document.getElementById('add-schedule');
        const formList = document.getElementById('schedule-form-list');
        const totalForms = document.getElementById('id_schedules-TOTAL_FORMS');

        function updateSections() {
            const classId = classSelect.value;
            sectionSelect.innerHTML = '<option value="">---------</option>';

            if (classId) {
                fetch(`{% url 'get_sections' %}?class_id=${classId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(section => {
                            const option = document.createElement('option');
                            option.value = section.id;
                            option.textContent = section.name;
                            sectionSelect.appendChild(option);
                        });
                    });
            }
        }

        function updateSubjects(selectElement) {
            const classId = classSelect.value;
            const currentSubjectId = selectElement.value; // Store current selection
            selectElement.innerHTML = '<option value="">---------</option>';

            if (classId) {
                fetch(`{% url 'get_subjects' %}?class_id=${classId}`)
                    .then(response => response.json())
                    .then(data => {
                        data.forEach(subject => {
                            const option = document.createElement('option');
                            option.value = subject.id;
                            option.textContent = subject.name;
                            if (subject.id == currentSubjectId) {
                                option.selected = true;
                            }
                            selectElement.appendChild(option);
                        });
                    });
            }
        }

        function updateAllSubjectDropdowns() {
            const subjectSelects = formList.querySelectorAll('select[name$="-subject"]');
            subjectSelects.forEach(select => {
                updateSubjects(select);
            });
        }

        classSelect.addEventListener('change', function() {
            updateSections();
            updateAllSubjectDropdowns();
        });

        // Initial load
        if (classSelect.value) {
            // Don't clear sections on initial load if already selected (handled by Django form)
            // But do update subjects if needed, or rely on server-side rendering for initial state
            // For now, let's just ensure new rows get correct subjects
        }
        
        addBtn.addEventListener('click', function() {
            const forms = formList.getElementsByClassName('schedule-form');
            const currentFormCount = forms.length;
            const newForm = forms[0].cloneNode(true);
            
            // Update indices
            const regex = new RegExp(`schedules-(\\d+)-`, 'g');
            newForm.innerHTML = newForm.innerHTML.replace(regex, `schedules-${currentFormCount}-`);
            
            // Clear values
            const inputs = newForm.querySelectorAll('input, select');
            inputs.forEach(input => {
                if (input.type !== 'hidden') {
                    input.value = '';
                }
                if (input.type === 'checkbox') {
                    input.checked = false;
                }
            });
            
            formList.appendChild(newForm);
            totalForms.value = currentFormCount + 1;

            // Update subject dropdown for the new row
            const newSubjectSelect = newForm.querySelector('select[name$="-subject"]');
            updateSubjects(newSubjectSelect);
        });
    });
</script>
{% endblock %}
