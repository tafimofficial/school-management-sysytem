{% extends 'base.html' %}

{% block title %}Result Entry - SMS{% endblock %}

{% block content %}
<div class="d-sm-flex align-items-center justify-content-between mb-4">
    <h1 class="h3 mb-0 text-gray-800">Result Entry</h1>
</div>

<div class="card shadow mb-4">
    <div class="card-body">
        <form method="post" id="resultForm">
            {% csrf_token %}
            <div class="row mb-4">
                <div class="col-md-4">
                    <label class="form-label">Exam</label>
                    <select name="exam_id" class="form-select" required>
                        <option value="">Select Exam</option>
                        {% for exam in exams %}
                        <option value="{{ exam.id }}">{{ exam.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Class</label>
                    <select name="class_id" class="form-select" id="classSelect" required>
                        <option value="">Select Class</option>
                        {% for class in classes %}
                        <option value="{{ class.id }}">{{ class.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Subject</label>
                    <select name="subject_id" class="form-select" id="subjectSelect" required>
                        <option value="">Select Subject</option>
                        <!-- Populated via JS -->
                    </select>
                </div>
            </div>
            
            <div id="studentList" class="table-responsive" style="display:none;">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Student Name</th>
                            <th>Marks Obtained</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <tbody id="studentTableBody">
                        <!-- Populated via JS -->
                    </tbody>
                </table>
                <button type="submit" class="btn btn-primary">Save Results</button>
            </div>
        </form>
    </div>
</div>

{% block extra_js %}
<script>
    document.getElementById('classSelect').addEventListener('change', function() {
        const classId = this.value;
        const studentList = document.getElementById('studentList');
        const tbody = document.getElementById('studentTableBody');
        const subjectSelect = document.getElementById('subjectSelect');
        
        if (classId) {
            // Fetch Subjects
            fetch(`{% url 'get_subjects' %}?class_id=${classId}`)
                .then(response => response.json())
                .then(data => {
                    subjectSelect.innerHTML = '<option value="">Select Subject</option>';
                    data.forEach(subject => {
                        subjectSelect.insertAdjacentHTML('beforeend', `<option value="${subject.id}">${subject.name}</option>`);
                    });
                });

            // Fetch Students
            fetch(`{% url 'get_students' %}?class_id=${classId}`)
                .then(response => response.json())
                .then(data => {
                    tbody.innerHTML = ''; // Clear existing rows inside callback to avoid race conditions
                    if (data.length > 0) {
                        data.forEach(student => {
                            const row = `
                                <tr>
                                    <td>${student.name}</td>
                                    <td>
                                        <input type="number" class="form-control" name="marks_${student.id}" required>
                                    </td>
                                    <td>
                                        <input type="text" class="form-control" name="remarks_${student.id}">
                                    </td>
                                </tr>
                            `;
                            tbody.insertAdjacentHTML('beforeend', row);
                        });
                        studentList.style.display = 'block';
                        document.querySelector('.alert-info').style.display = 'none';
                    } else {
                        studentList.style.display = 'none';
                        document.querySelector('.alert-info').style.display = 'block';
                        document.querySelector('.alert-info').textContent = 'No students found in this class.';
                    }
                });
        } else {
            document.getElementById('subjectSelect').innerHTML = '<option value="">Select Subject</option>';
            studentList.style.display = 'none';
            document.querySelector('.alert-info').style.display = 'block';
        }
    });
</script>
{% endblock %}
{% endblock %}
